<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Messages - Motion-Flow</title>
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --color-dark: #0a0a12;
      --color-bg: #0f0f1a;
      --color-bg-light: #1a1a2e;
      --color-primary: #00bcd4;
      --color-accent: #00bcd4;
      --color-accent-alt: #f97316;
      --color-success: #10b981;
      --color-warning: #f59e0b;
      --color-error: #ef4444;
      --color-text: #e2e8f0;
      --color-text-muted: #94a3b8;
      --font-heading: 'Orbitron', sans-serif;
      --font-body: 'Inter', sans-serif;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: var(--font-body);
    }

    body {
      margin: 0;
      min-height: 100vh;
      background-color: var(--color-bg);
      color: var(--color-text);
      overflow-x: hidden;
      position: relative;
      display: flex;
      flex-direction: column;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: 
        radial-gradient(circle at 20% 50%, rgba(0, 188, 212, 0.05) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(249, 115, 22, 0.05) 0%, transparent 50%);
      pointer-events: none;
      z-index: 0;
    }

    /* Mobile Navbar */
    .mobile-navbar {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 60px;
      background: rgba(15, 17, 30, 0.98);
      z-index: 1002;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(0, 188, 212, 0.2);
    }

    .navbar-content {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .menu-btn {
      background: none;
      border: none;
      color: var(--color-accent);
      font-size: 1.8em;
      cursor: pointer;
      padding: 5px;
      transition: all 0.3s ease;
      z-index: 1003;
    }

    .menu-btn:hover {
      color: var(--color-accent-alt);
      transform: scale(1.1);
    }

    .logo {
      font-family: var(--font-heading);
      font-size: 1.4em;
      font-weight: 900;
      letter-spacing: 2px;
    }

    .logo .motion { color: #ffffff; }
    .logo .flow { 
      color: var(--color-accent);
      background: linear-gradient(135deg, var(--color-accent), var(--color-accent-alt));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }

    /* Sidebar */
    .sidebar {
      position: fixed;
      top: 0;
      left: -320px;
      width: 300px;
      height: 100vh;
      background: rgba(15, 17, 30, 0.98);
      color: #fff;
      display: flex;
      flex-direction: column;
      z-index: 1001;
      box-shadow: 2px 0 20px rgba(0, 188, 212, 0.2);
      backdrop-filter: blur(10px);
      transition: left 0.3s cubic-bezier(.4,0,.2,1);
      overflow-y: auto;
    }

    .sidebar.active {
      left: 0;
    }

    .sidebar-header {
      padding: 80px 25px 30px;
      background: rgba(15, 17, 30, 0.95);
      border-bottom: 1px solid rgba(0, 188, 212, 0.2);
      text-align: center;
    }

    .sidebar-nav {
      padding: 25px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      flex: 1;
    }

    .nav-btn {
      background: rgba(255, 255, 255, 0.05);
      color: #fff;
      border: 1px solid rgba(0, 188, 212, 0.1);
      padding: 15px 18px;
      border-radius: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 15px;
      font-size: 0.95em;
      font-weight: 600;
      transition: all 0.3s ease;
      text-align: left;
      position: relative;
      width: 100%;
      text-decoration: none;
    }

    .nav-btn:hover {
      background: rgba(0, 188, 212, 0.1);
      border-color: rgba(0, 188, 212, 0.3);
      transform: translateX(5px);
      box-shadow: 0 0 20px rgba(0, 188, 212, 0.2);
    }

    .nav-btn.active {
      background: linear-gradient(135deg, rgba(0, 188, 212, 0.1), rgba(249, 115, 22, 0.1));
      border-color: rgba(0, 188, 212, 0.4);
    }

    .nav-btn i {
      color: var(--color-accent);
      font-size: 1.2em;
      width: 24px;
      text-align: center;
    }

    .notification-badge {
      background: linear-gradient(135deg, #ff4757, #ff3742);
      color: white;
      font-size: 0.7rem;
      padding: 2px 8px;
      border-radius: 10px;
      margin-left: auto;
    }

    /* Main Content */
    .main-content {
      flex: 1;
      padding: 80px 20px 120px;
      position: relative;
      z-index: 1;
      width: 100%;
      max-width: 1400px;
      margin: 0 auto;
    }

    /* Messages Header */
    .messages-header {
      text-align: center;
      margin-bottom: 40px;
      padding: 0 10px;
    }

    .messages-header h1 {
      font-family: var(--font-heading);
      font-size: clamp(1.8em, 5vw, 2.8em);
      background: linear-gradient(135deg, var(--color-accent), var(--color-accent-alt));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      margin-bottom: 15px;
      letter-spacing: 2px;
      text-shadow: 0 0 10px rgba(0, 188, 212, 0.3);
      line-height: 1.2;
    }

    .messages-header p {
      color: var(--color-text-muted);
      font-size: clamp(0.9em, 3vw, 1.1em);
      opacity: 0.8;
      line-height: 1.5;
      max-width: 600px;
      margin: 0 auto;
    }

    /* Messages Container */
    .messages-container {
      background: var(--color-bg-light);
      border: 1px solid rgba(255, 255, 255, 0.05);
      border-radius: 16px;
      overflow: hidden;
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 32px rgba(0, 188, 212, 0.1);
      max-width: 800px;
      margin: 0 auto;
    }

    /* Chat List */
    .chat-list {
      max-height: 600px;
      overflow-y: auto;
    }

    .chat-item {
      display: flex;
      align-items: center;
      padding: 20px;
      border-bottom: 1px solid rgba(0, 188, 212, 0.1);
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      text-decoration: none;
      color: inherit;
    }

    .chat-item:hover {
      background: rgba(0, 188, 212, 0.05);
      text-decoration: none;
      color: inherit;
    }

    .chat-item.active {
      background: rgba(0, 188, 212, 0.1);
      border-left: 4px solid var(--color-accent);
    }

    .chat-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid rgba(0, 188, 212, 0.3);
      margin-right: 15px;
    }

    .chat-info {
      flex: 1;
    }

    .chat-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 5px;
    }

    .chat-name {
      color: var(--color-text);
      font-weight: 600;
      font-size: 1em;
    }

    .chat-time {
      color: var(--color-text-muted);
      font-size: 0.8em;
      opacity: 0.7;
    }

    .chat-preview {
      color: var(--color-text-muted);
      font-size: 0.9em;
      opacity: 0.8;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 500px;
    }

    .chat-badge {
      background: linear-gradient(135deg, var(--color-error), #dc2626);
      color: #fff;
      font-size: 0.7em;
      font-weight: 700;
      padding: 3px 8px;
      border-radius: 10px;
      min-width: 20px;
      text-align: center;
      margin-left: 10px;
    }

    /* No Messages State */
    .no-messages {
      text-align: center;
      padding: 80px 20px;
      color: var(--color-text-muted);
    }

    .no-messages i {
      font-size: 4em;
      color: rgba(0, 188, 212, 0.3);
      margin-bottom: 20px;
    }

    .no-messages h3 {
      font-size: 1.5em;
      margin-bottom: 10px;
      color: var(--color-text);
    }

    .no-messages p {
      font-size: 1.1em;
      opacity: 0.8;
    }

    /* Loading Animation */
    .loading-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 100px 20px;
      text-align: center;
    }

    .loading-spinner {
      width: 60px;
      height: 60px;
      border: 4px solid rgba(0, 188, 212, 0.1);
      border-radius: 50%;
      border-top-color: var(--color-accent);
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }

    .loading-text {
      color: var(--color-text-muted);
      font-size: 1.1em;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Sidebar Overlay */
    .sidebar-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      backdrop-filter: blur(5px);
    }

    .sidebar-overlay.active {
      display: block;
    }

    /* Bottom Navigation */
    .bottom-nav-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      display: flex;
      justify-content: space-around;
      align-items: center;
      padding: 10px 0;
      z-index: 990;
      background: rgba(10, 10, 18, 0.7);
      backdrop-filter: blur(25px) saturate(150%);
      -webkit-backdrop-filter: blur(25px) saturate(150%);
      border-top: 1px solid rgba(0, 188, 212, 0.3);
      box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.5), 0 -2px 10px rgba(0, 188, 212, 0.1);
    }

    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-decoration: none;
      color: var(--color-text-muted);
      font-size: 0.7rem;
      font-weight: 500;
      padding: 5px 10px;
      border-radius: 8px;
      transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      position: relative;
    }

    .nav-item i {
      font-size: 1.2rem;
      margin-bottom: 2px;
      transition: color 0.3s;
    }

    .nav-item.active {
      color: var(--color-primary);
      transform: scale(1.05);
    }

    .nav-item.active i {
      color: var(--color-primary);
      text-shadow: 0 0 8px rgba(0, 188, 212, 0.8);
    }

    .nav-item:hover {
      color: var(--color-primary);
    }

    /* Simple Footer */
    .simple-footer {
      text-align: center;
      padding: 20px;
      color: var(--color-text-muted);
      font-size: 0.9em;
      margin-top: 50px;
      margin-bottom: 80px;
    }

    .simple-footer a {
      color: var(--color-accent);
      text-decoration: none;
      transition: all 0.3s ease;
    }

    .simple-footer a:hover {
      text-decoration: underline;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .main-content {
        padding: 70px 15px 100px;
      }
      
      .messages-container {
        max-height: calc(100vh - 200px);
      }
      
      .chat-item {
        padding: 15px;
      }
      
      .chat-avatar {
        width: 45px;
        height: 45px;
        margin-right: 12px;
      }
      
      .chat-preview {
        max-width: 300px;
      }
    }

    @media (max-width: 480px) {
      .main-content {
        padding: 70px 10px 90px;
      }
      
      .chat-item {
        padding: 12px;
      }
      
      .chat-avatar {
        width: 40px;
        height: 40px;
      }
      
      .chat-name {
        font-size: 0.9em;
      }
      
      .chat-preview {
        font-size: 0.8em;
        max-width: 200px;
      }
    }

    /* Toast Notification */
    .toast {
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(15, 17, 30, 0.95);
      color: white;
      padding: 15px 25px;
      border-radius: 10px;
      border: 1px solid rgba(0, 188, 212, 0.3);
      backdrop-filter: blur(10px);
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
      z-index: 2001;
      display: none;
      align-items: center;
      gap: 10px;
      animation: slideUp 0.3s ease;
    }

    .toast.show {
      display: flex;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateX(-50%) translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
    }
  </style>
</head>
<body>
  <!-- Mobile Navbar -->
  <div class="mobile-navbar">
    <div class="navbar-content">
      <button class="menu-btn" id="openSidebar">â˜°</button>
      <div class="logo">
        <span class="motion">MOTION</span><span class="flow">FLOW</span>
      </div>
    </div>
  </div>
  
  <!-- Sidebar Overlay -->
  <div class="sidebar-overlay" id="sidebarOverlay"></div>
  
  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div class="logo" style="font-size: 1.8em;">
        <span class="motion">MOTION</span><span class="flow">FLOW</span>
      </div>
    </div>
    <div class="sidebar-nav">
      <a href="../homepage.html" class="nav-btn">
        <i class="fas fa-home"></i>
        Home
      </a>

      <a href="../apk/apk.html" class="nav-btn">
        <i class="fas fa-download"></i>
        APK Share
      </a>

      <a href="../Users/users.html" class="nav-btn">
        <i class="fas fa-users"></i>
        Users
      </a>

      <a href="chats.html" class="nav-btn active">
        <i class="fas fa-comments"></i>
        Messages
        <span class="notification-badge" id="chatNotificationBadge" style="display: none;">0</span>
      </a>

      <!-- Admin Only Section -->
      <div id="adminSection" style="display: none;">
        <a href="../Host/host.html" class="nav-btn">
          <i class="fas fa-upload"></i>
          Upload Project
        </a>
      </div>

      <a href="../Settings/settings.html" class="nav-btn">
        <i class="fas fa-cog"></i>
        Settings
      </a>

      <button class="nav-btn" id="logOutBtn" style="margin-top: auto; background: rgba(229, 57, 53, 0.1); border-color: rgba(229, 57, 53, 0.3); color: #e53935;">
        <i class="fas fa-sign-out-alt"></i>
        Logout
      </button>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content" id="mainContent">
    <!-- Messages Header -->
    <div class="messages-header">
      <h1>Messages</h1>
      <p>Connect with other creators and collaborate on projects</p>
    </div>
    
    <!-- Messages Container -->
    <div class="messages-container">
      <div class="chat-list" id="chatList">
        <!-- Loading state initially -->
        <div class="loading-container" id="loadingContainer">
          <div class="loading-spinner"></div>
          <div class="loading-text">Loading conversations...</div>
        </div>
        
        <!-- Chat items will be loaded here -->
        <div class="no-messages" id="noMessages" style="display: none;">
          <i class="fas fa-comments"></i>
          <h3>No Conversations Yet</h3>
          <p>Start a conversation with other creators to collaborate on projects</p>
          <p style="margin-top: 15px; font-size: 0.9em;">Visit the <a href="../Users/users.html" style="color: var(--color-accent);">Users page</a> to find creators to message</p>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Simple Footer -->
  <footer class="simple-footer">
    <p>Made with <i class="fas fa-heart" style="color: #ef4444;"></i> by <a href="https://t.me/eclipsia_techs" target="_blank">eclipsia-techs</a></p>
  </footer>

  <!-- Bottom Navigation -->
  <footer class="bottom-nav-bar">
    <a href="../homepage.html" class="nav-item">
      <i class="fas fa-home"></i>
      <span>Home</span>
    </a>
    
    <a href="../updates/updates.html" class="nav-item">
      <i class="fas fa-bell"></i>
      <span>Updates</span>
    </a>
    
    <a href="../Live_Chat/live.html" class="nav-item">
      <i class="fas fa-comments"></i>
      <span>Live Chat</span>
    </a>
    
    <a href="../profile/profile.html" class="nav-item">
      <i class="fas fa-user"></i>
      <span>Profile</span>
    </a>
  </footer>

  <!-- Toast Notification -->
  <div class="toast" id="toast">
    <i class="fas fa-check-circle" id="toastIcon"></i>
    <span id="toastMessage">Notification</span>
  </div>

  <!-- Logout Confirmation Dialog -->
  <div class="logout-dialog" id="logoutDialog" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(5, 5, 26, 0.95); z-index: 2000; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(10px);">
    <div class="logout-content" style="background: rgba(15, 17, 30, 0.95); padding: 30px; border-radius: 16px; max-width: 500px; width: 90%; border: 1px solid rgba(0, 188, 212, 0.2); box-shadow: 0 0 40px rgba(0, 188, 212, 0.3); backdrop-filter: blur(10px);">
      <h2 style="margin-bottom: 15px;">Logout Confirmation</h2>
      <p>Are you sure you want to logout of your account?</p>
      <div class="logout-buttons" style="display: flex; gap: 15px; margin-top: 20px;">
        <button class="logout-confirm-btn" id="logoutConfirm" style="background: linear-gradient(135deg, #ff4757, #ff3742); color: white; padding: 12px 24px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; flex: 1;">Yes, Logout</button>
        <button class="logout-cancel-btn" id="logoutCancel" style="background: rgba(255, 255, 255, 0.1); color: white; border: 1px solid rgba(0, 188, 212, 0.2); padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; flex: 1;">Cancel</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { ref, getDatabase, onValue, update, query, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";
    import { onAuthStateChanged, getAuth, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

    // Use the SAME Firebase config as homepage.html
    const firebaseConfig = {
      apiKey: "AIzaSyCy5uQGcg1cALqFSa1xAQOL6lX8Gz5nFNU",
      authDomain: "motion-flow-47450.firebasestorage.app",
      databaseURL: "https://motion-flow-47450-default-rtdb.firebaseio.com",
      projectId: "motion-flow-47450",
      storageBucket: "motion-flow-47450.firebasestorage.app",
      messagingSenderId: "686875529848",
      appId: "1:686875529848:web:48edf5164aaaf938cdd38d",
      measurementId: "G-K46N8C1HFQ"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase();

    console.log('ðŸ’¬ Motion-Flow Messages initialized');

    // DOM Elements
    const chatList = document.getElementById("chatList");
    const loadingContainer = document.getElementById("loadingContainer");
    const noMessages = document.getElementById("noMessages");
    const sidebar = document.getElementById('sidebar');
    const openSidebar = document.getElementById('openSidebar');
    const sidebarOverlay = document.getElementById('sidebarOverlay');
    const logOutBtn = document.getElementById("logOutBtn");
    const logoutDialog = document.getElementById("logoutDialog");
    const logoutConfirm = document.getElementById("logoutConfirm");
    const logoutCancel = document.getElementById("logoutCancel");
    const chatNotificationBadge = document.getElementById("chatNotificationBadge");
    const toast = document.getElementById("toast");
    const toastMessage = document.getElementById("toastMessage");
    const toastIcon = document.getElementById("toastIcon");

    // User state
    let currentUserId = null;
    let currentUserName = null;
    let currentUserAvatar = null;
    let sidebarOpen = false;
    let conversations = [];

    // Admin users
    const adminUsers = [
      "YOUR_ADMIN_UID_HERE"
    ];

    // Toast notification function
    function showToast(message, type = 'info') {
      toastMessage.textContent = message;
      toastIcon.className = type === 'success' ? 'fas fa-check-circle' : 
                           type === 'error' ? 'fas fa-exclamation-circle' : 
                           'fas fa-info-circle';
      
      toast.classList.add('show');
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    // Sidebar functionality
    function toggleSidebar() {
      sidebarOpen = !sidebarOpen;
      if (sidebarOpen) {
        sidebar.classList.add('active');
        sidebarOverlay.classList.add('active');
      } else {
        sidebar.classList.remove('active');
        sidebarOverlay.classList.remove('active');
      }
    }

    openSidebar.addEventListener('click', toggleSidebar);
    sidebarOverlay.addEventListener('click', toggleSidebar);

    // Logout functionality
    logOutBtn.addEventListener("click", () => {
      logoutDialog.style.display = 'flex';
    });

    logoutConfirm.addEventListener("click", async () => {
      try {
        const user = auth.currentUser;
        if (user) {
          await update(ref(db, "users/" + user.uid), {
            status: "offline",
            lastSeen: Date.now()
          });
        }
        await signOut(auth);
        window.location.href = "../index.html";
      } catch (error) {
        console.error("Logout failed:", error);
        showToast("Something went wrong while logging out", "error");
      }
    });

    logoutCancel.addEventListener("click", () => {
      logoutDialog.style.display = 'none';
    });

    logoutDialog.addEventListener('click', (e) => {
      if (e.target === logoutDialog) {
        logoutDialog.style.display = 'none';
      }
    });

    // Auth state listener
    onAuthStateChanged(auth, (user) => {
      if (user) {
        currentUserId = user.uid;
        console.log('âœ… User logged in:', user.uid);
        
        // Load user data
        const userRef = ref(db, `users/${user.uid}`);
        onValue(userRef, (snapshot) => {
          if (snapshot.exists()) {
            const userData = snapshot.val();
            currentUserName = userData.username || userData.name || "User";
            currentUserAvatar = userData.profilePhoto || `https://via.placeholder.com/50/00bcd4/fff?text=${currentUserName.charAt(0)}`;
            
            // Show admin section if user is admin
            if (adminUsers.includes(user.uid)) {
              document.getElementById('adminSection').style.display = 'block';
            }
            
            // Load conversations
            loadConversations();
          }
        });
      } else {
        window.location.href = "../index.html";
      }
    });

    // Load conversations from Firebase
    function loadConversations() {
      console.log('ðŸ“± Loading conversations...');
      
      // Get all users to create conversation list
      const usersRef = ref(db, "users");
      onValue(usersRef, (usersSnapshot) => {
        if (usersSnapshot.exists()) {
          const usersData = usersSnapshot.val();
          const usersList = Object.keys(usersData).map(uid => ({
            uid,
            ...usersData[uid]
          })).filter(user => user.uid !== currentUserId); // Exclude current user
          
          // Now get conversations for current user
          const conversationsRef = ref(db, `conversations/${currentUserId}`);
          onValue(conversationsRef, (convSnapshot) => {
            loadingContainer.style.display = 'none';
            
            if (convSnapshot.exists()) {
              const convData = convSnapshot.val();
              conversations = [];
              
              // Process each conversation
              Object.keys(convData).forEach(otherUserId => {
                const conversation = convData[otherUserId];
                const otherUser = usersList.find(u => u.uid === otherUserId);
                
                if (otherUser) {
                  // Get last message
                  const messages = conversation.messages || {};
                  const messageKeys = Object.keys(messages);
                  const lastMessageKey = messageKeys[messageKeys.length - 1];
                  const lastMessage = lastMessageKey ? messages[lastMessageKey] : null;
                  
                  // Count unread messages
                  let unreadCount = 0;
                  Object.values(messages).forEach(msg => {
                    if (msg.senderId !== currentUserId && !msg.read) {
                      unreadCount++;
                    }
                  });
                  
                  conversations.push({
                    id: otherUserId,
                    otherUserId: otherUserId,
                    name: otherUser.username || otherUser.name || "User",
                    avatar: otherUser.profilePhoto || `https://via.placeholder.com/50/00bcd4/fff?text=${otherUser.username?.charAt(0) || 'U'}`,
                    lastMessage: lastMessage ? lastMessage.text : "Start a conversation",
                    timestamp: lastMessage ? lastMessage.timestamp : conversation.createdAt || Date.now(),
                    unread: unreadCount,
                    lastMessageText: lastMessage ? lastMessage.text : ""
                  });
                }
              });
              
              // Sort by last message timestamp (most recent first)
              conversations.sort((a, b) => b.timestamp - a.timestamp);
              
              renderConversations();
              updateNotificationBadge();
            } else {
              // No conversations yet
              showNoConversations();
            }
          }, (error) => {
            console.error("Error loading conversations:", error);
            loadingContainer.style.display = 'none';
            showNoConversations();
          });
        } else {
          loadingContainer.style.display = 'none';
          showNoConversations();
        }
      });
    }

    // Show no conversations state
    function showNoConversations() {
      loadingContainer.style.display = 'none';
      noMessages.style.display = 'block';
    }

    // Render conversations
    function renderConversations() {
      if (conversations.length === 0) {
        showNoConversations();
        return;
      }
      
      noMessages.style.display = 'none';
      chatList.innerHTML = '';
      
      conversations.forEach(conversation => {
        const chatItem = document.createElement('a');
        chatItem.className = 'chat-item';
        chatItem.href = `chat.html?userId=${conversation.otherUserId}`;
        
        chatItem.innerHTML = `
          <img src="${conversation.avatar}" alt="${conversation.name}" class="chat-avatar" onerror="this.src='https://via.placeholder.com/50/00bcd4/fff?text=${conversation.name.charAt(0)}'">
          <div class="chat-info">
            <div class="chat-header">
              <div class="chat-name">${conversation.name}</div>
              <div class="chat-time">${getTimeAgo(conversation.timestamp)}</div>
            </div>
            <div class="chat-preview">${conversation.lastMessageText}</div>
          </div>
          ${conversation.unread > 0 ? `<div class="chat-badge">${conversation.unread}</div>` : ''}
        `;
        
        chatList.appendChild(chatItem);
      });
    }

    // Update notification badge
    function updateNotificationBadge() {
      const totalUnread = conversations.reduce((sum, conv) => sum + conv.unread, 0);
      
      if (totalUnread > 0) {
        chatNotificationBadge.textContent = totalUnread > 9 ? '9+' : totalUnread;
        chatNotificationBadge.style.display = 'block';
      } else {
        chatNotificationBadge.style.display = 'none';
      }
    }

    // Utility functions
    function getTimeAgo(timestamp) {
      const now = Date.now();
      const diff = now - timestamp;
      const seconds = Math.floor(diff / 1000);
      const minutes = Math.floor(seconds / 60);
      const hours = Math.floor(minutes / 60);
      const days = Math.floor(hours / 24);
      
      if (days > 0) return `${days}d ago`;
      if (hours > 0) return `${hours}h ago`;
      if (minutes > 0) return `${minutes}m ago`;
      return 'Just now';
    }

    // Handle escape key to close sidebar and dialogs
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        if (sidebarOpen) {
          toggleSidebar();
        }
        if (logoutDialog.style.display === 'flex') {
          logoutDialog.style.display = 'none';
        }
      }
    });

    // Initialize on load
    document.addEventListener('DOMContentLoaded', () => {
      console.log('ðŸ’¬ Messages page loaded');
    });
  </script>
</body>
</html>