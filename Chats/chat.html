<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat - Motion-Flow</title>
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --color-dark: #0a0a12;
      --color-bg: #0f0f1a;
      --color-bg-light: #1a1a2e;
      --color-primary: #00bcd4;
      --color-accent: #00bcd4;
      --color-accent-alt: #f97316;
      --color-success: #10b981;
      --color-warning: #f59e0b;
      --color-error: #ef4444;
      --color-text: #e2e8f0;
      --color-text-muted: #94a3b8;
      --whatsapp-bg: #0c1317;
      --whatsapp-chat-bg: #0a1014;
      --whatsapp-sent: #005c4b;
      --whatsapp-received: #202c33;
      --font-heading: 'Orbitron', sans-serif;
      --font-body: 'Inter', sans-serif;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: var(--font-body);
    }

    body {
      margin: 0;
      min-height: 100vh;
      background-color: var(--whatsapp-bg);
      color: var(--color-text);
      overflow-x: hidden;
      position: relative;
      display: flex;
      flex-direction: column;
    }

    /* WhatsApp-style background pattern */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23005c4b' fill-opacity='0.03'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
      background-size: 120px;
      opacity: 0.15;
      pointer-events: none;
      z-index: 0;
    }

    /* Chat Header */
    .chat-header {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 60px;
      background: var(--whatsapp-chat-bg);
      z-index: 1002;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 16px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 15px;
      flex: 1;
    }

    .back-btn {
      background: none;
      border: none;
      color: var(--color-text);
      font-size: 1.5em;
      cursor: pointer;
      padding: 8px;
      border-radius: 50%;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .back-btn:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
      flex: 1;
    }

    .user-info:hover {
      opacity: 0.9;
    }

    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid rgba(0, 188, 212, 0.3);
    }

    .user-details h3 {
      font-size: 1em;
      font-weight: 600;
      color: var(--color-text);
      margin-bottom: 2px;
    }

    .user-details p {
      font-size: 0.8em;
      color: var(--color-success);
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .user-details .offline {
      color: var(--color-text-muted);
    }

    .dot {
      width: 8px;
      height: 8px;
      background: var(--color-success);
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .header-btn {
      background: none;
      border: none;
      color: var(--color-text-muted);
      font-size: 1.3em;
      cursor: pointer;
      padding: 8px;
      border-radius: 50%;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .header-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      color: var(--color-text);
    }

    /* Main Chat Area */
    .chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding-top: 60px;
      padding-bottom: 70px;
      position: relative;
      z-index: 1;
    }

    /* Messages Area */
    .messages-area {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      background-color: var(--whatsapp-bg);
      background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23005c4b' fill-opacity='0.03'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
      background-size: 120px;
    }

    /* Message Bubbles */
    .message {
      display: flex;
      max-width: 70%;
      animation: fadeIn 0.3s ease;
      position: relative;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .message.sent {
      align-self: flex-end;
      flex-direction: row;
    }

    .message.received {
      align-self: flex-start;
      flex-direction: row;
    }

    .message-bubble {
      padding: 8px 12px;
      border-radius: 7.5px;
      position: relative;
      word-wrap: break-word;
      max-width: 100%;
      box-shadow: 0 1px 0.5px rgba(0, 0, 0, 0.13);
    }

    .message.sent .message-bubble {
      background: var(--whatsapp-sent);
      color: white;
      border-top-right-radius: 0;
      margin-left: auto;
    }

    .message.received .message-bubble {
      background: var(--whatsapp-received);
      color: var(--color-text);
      border-top-left-radius: 0;
    }

    /* Arrow tails for bubbles */
    .message.sent .message-bubble::before {
      content: '';
      position: absolute;
      top: 0;
      right: -8px;
      width: 0;
      height: 0;
      border-left: 8px solid var(--whatsapp-sent);
      border-top: 8px solid transparent;
      border-bottom: 8px solid transparent;
    }

    .message.received .message-bubble::before {
      content: '';
      position: absolute;
      top: 0;
      left: -8px;
      width: 0;
      height: 0;
      border-right: 8px solid var(--whatsapp-received);
      border-top: 8px solid transparent;
      border-bottom: 8px solid transparent;
    }

    .message-text {
      font-size: 0.95em;
      line-height: 1.4;
      white-space: pre-wrap;
    }

    .message-info {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 6px;
      margin-top: 4px;
      margin-left: auto;
      width: fit-content;
    }

    .message-time {
      font-size: 0.7em;
      opacity: 0.8;
      color: rgba(255, 255, 255, 0.7);
    }

    .message.received .message-time {
      color: rgba(255, 255, 255, 0.6);
    }

    .message-status {
      font-size: 0.7em;
      color: rgba(255, 255, 255, 0.7);
    }

    .message-status i {
      font-size: 0.9em;
    }

    /* Date Separator */
    .date-separator {
      text-align: center;
      margin: 15px 0;
      position: relative;
    }

    .date-separator span {
      background: rgba(255, 255, 255, 0.1);
      color: var(--color-text-muted);
      font-size: 0.8em;
      padding: 4px 12px;
      border-radius: 20px;
      display: inline-block;
      backdrop-filter: blur(10px);
    }

    /* Typing Indicator */
    .typing-indicator {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 10px 16px;
      background: var(--whatsapp-received);
      border-radius: 18px;
      width: fit-content;
      margin-bottom: 10px;
      align-self: flex-start;
      box-shadow: 0 1px 0.5px rgba(0, 0, 0, 0.13);
    }

    .typing-indicator::before {
      content: '';
      position: absolute;
      top: 0;
      left: -8px;
      width: 0;
      height: 0;
      border-right: 8px solid var(--whatsapp-received);
      border-top: 8px solid transparent;
      border-bottom: 8px solid transparent;
    }

    .typing-dot {
      width: 8px;
      height: 8px;
      background: rgba(255, 255, 255, 0.6);
      border-radius: 50%;
      animation: typingAnimation 1.4s infinite;
    }

    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }

    @keyframes typingAnimation {
      0%, 60%, 100% { transform: translateY(0); }
      30% { transform: translateY(-4px); }
    }

    /* Input Area */
    .input-area {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: var(--whatsapp-chat-bg);
      padding: 10px 16px;
      border-top: 1px solid rgba(255, 255, 255, 0.08);
      z-index: 1001;
    }

    .input-wrapper {
      display: flex;
      gap: 10px;
      align-items: center;
      background: var(--whatsapp-received);
      border-radius: 24px;
      padding: 8px 16px;
    }

    .emoji-btn, .attach-btn {
      background: none;
      border: none;
      color: var(--color-text-muted);
      font-size: 1.3em;
      cursor: pointer;
      padding: 8px;
      border-radius: 50%;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .emoji-btn:hover, .attach-btn:hover {
      color: var(--color-text);
    }

    .message-input {
      flex: 1;
      background: none;
      border: none;
      color: var(--color-text);
      font-size: 0.95em;
      resize: none;
      min-height: 20px;
      max-height: 100px;
      padding: 8px 0;
      outline: none;
      font-family: inherit;
    }

    .message-input::placeholder {
      color: var(--color-text-muted);
    }

    .send-btn {
      background: var(--whatsapp-sent);
      color: white;
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .send-btn:hover:not(:disabled) {
      background: #006d58;
      transform: scale(1.1);
    }

    .send-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      background: var(--color-text-muted);
    }

    /* Loading Animation */
    .loading-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 100px 20px;
      text-align: center;
      flex: 1;
      background: var(--whatsapp-bg);
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(0, 188, 212, 0.1);
      border-radius: 50%;
      border-top-color: var(--whatsapp-sent);
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }

    .loading-text {
      color: var(--color-text-muted);
      font-size: 1em;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* No Messages State */
    .no-messages {
      text-align: center;
      padding: 60px 20px;
      color: var(--color-text-muted);
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: var(--whatsapp-bg);
    }

    .no-messages i {
      font-size: 3em;
      color: rgba(0, 92, 75, 0.3);
      margin-bottom: 20px;
    }

    .no-messages h3 {
      font-size: 1.2em;
      margin-bottom: 10px;
      color: var(--color-text);
    }

    .no-messages p {
      font-size: 0.95em;
      opacity: 0.8;
      max-width: 300px;
    }

    /* Toast Notification */
    .toast {
      position: fixed;
      top: 70px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(32, 44, 51, 0.95);
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      border: 1px solid rgba(0, 92, 75, 0.3);
      backdrop-filter: blur(10px);
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
      z-index: 2001;
      display: none;
      align-items: center;
      gap: 10px;
      animation: slideDown 0.3s ease;
      max-width: 90%;
    }

    .toast.show {
      display: flex;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateX(-50%) translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
    }

    /* Request Message Banner */
    .request-banner {
      background: linear-gradient(135deg, rgba(249, 115, 22, 0.1), rgba(59, 130, 246, 0.1));
      border: 1px solid rgba(249, 115, 22, 0.3);
      border-radius: 12px;
      padding: 20px;
      margin: 20px;
      text-align: center;
      backdrop-filter: blur(10px);
    }

    .request-banner h3 {
      color: var(--color-accent-alt);
      margin-bottom: 10px;
      font-size: 1.2em;
    }

    .request-banner p {
      color: var(--color-text-muted);
      margin-bottom: 15px;
      font-size: 0.95em;
    }

    .request-actions {
      display: flex;
      gap: 10px;
      justify-content: center;
    }

    .accept-btn, .decline-btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .accept-btn {
      background: linear-gradient(135deg, var(--color-success), #059669);
      color: white;
    }

    .accept-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(16, 185, 129, 0.3);
    }

    .decline-btn {
      background: rgba(255, 255, 255, 0.1);
      color: var(--color-text);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .decline-btn:hover {
      background: rgba(239, 68, 68, 0.1);
      color: var(--color-error);
      border-color: rgba(239, 68, 68, 0.3);
    }

    /* Scrollbar Styling */
    .messages-area::-webkit-scrollbar {
      width: 6px;
    }

    .messages-area::-webkit-scrollbar-track {
      background: transparent;
    }

    .messages-area::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 3px;
    }

    .messages-area::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .message {
        max-width: 85%;
      }
      
      .messages-area {
        padding: 15px;
      }
      
      .input-area {
        padding: 8px 12px;
      }
      
      .input-wrapper {
        padding: 6px 12px;
      }
      
      .request-banner {
        margin: 15px;
        padding: 15px;
      }
    }

    @media (max-width: 480px) {
      .message {
        max-width: 90%;
      }
      
      .chat-header {
        padding: 0 12px;
      }
      
      .header-btn {
        font-size: 1.2em;
        padding: 6px;
      }
      
      .user-details h3 {
        font-size: 0.95em;
      }
      
      .message-bubble {
        padding: 6px 10px;
      }
      
      .message-text {
        font-size: 0.9em;
      }
      
      .request-actions {
        flex-direction: column;
      }
      
      .accept-btn, .decline-btn {
        width: 100%;
      }
    }

    /* Message Animation for New Messages */
    @keyframes messageSlide {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .message.new {
      animation: messageSlide 0.3s ease;
    }

    /* Online Status Dot */
    .online-dot {
      display: inline-block;
      width: 8px;
      height: 8px;
      background: var(--color-success);
      border-radius: 50%;
      margin-right: 4px;
      animation: pulse 2s infinite;
    }
  </style>
</head>
<body>
  <!-- Chat Header with User Info -->
  <div class="chat-header" id="chatHeader">
    <div class="header-left">
      <button class="back-btn" id="backBtn">
        <i class="fas fa-arrow-left"></i>
      </button>
      <div class="user-info" id="userInfo">
        <!-- Dynamically loaded -->
      </div>
    </div>
    <div class="header-right">
      <button class="header-btn" id="videoCallBtn">
        <i class="fas fa-video"></i>
      </button>
      <button class="header-btn" id="voiceCallBtn">
        <i class="fas fa-phone"></i>
      </button>
      <button class="header-btn" id="moreBtn">
        <i class="fas fa-ellipsis-v"></i>
      </button>
    </div>
  </div>

  <!-- Main Chat Area -->
  <div class="chat-container">
    <!-- Messages Area -->
    <div class="messages-area" id="messagesArea">
      <!-- Loading state initially -->
      <div class="loading-container" id="loadingContainer">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">Loading chat...</div>
      </div>
      
      <!-- Messages will be loaded here -->
      <div class="no-messages" id="noMessages" style="display: none;">
        <i class="fas fa-comments"></i>
        <h3>Start a conversation</h3>
        <p>Send your first message to begin chatting</p>
      </div>
      
      <!-- Request Banner (shown for first-time messages) -->
      <div class="request-banner" id="requestBanner" style="display: none;">
        <h3><i class="fas fa-user-clock"></i> Message Request</h3>
        <p>This person wants to message you. Accept to start chatting.</p>
        <div class="request-actions">
          <button class="accept-btn" id="acceptRequestBtn">
            <i class="fas fa-check"></i> Accept
          </button>
          <button class="decline-btn" id="declineRequestBtn">
            <i class="fas fa-times"></i> Decline
          </button>
        </div>
      </div>
    </div>
    
    <!-- Typing Indicator -->
    <div class="typing-indicator" id="typingIndicator" style="display: none;">
      <div class="typing-dot"></div>
      <div class="typing-dot"></div>
      <div class="typing-dot"></div>
    </div>
  </div>

  <!-- Input Area -->
  <div class="input-area" id="inputArea" style="display: none;">
    <div class="input-wrapper">
      <button class="emoji-btn" id="emojiBtn">
        <i class="far fa-smile"></i>
      </button>
      <button class="attach-btn" id="attachBtn">
        <i class="fas fa-paperclip"></i>
      </button>
      <textarea 
        class="message-input" 
        id="messageInput" 
        placeholder="Type a message"
        rows="1"
        maxlength="1000"
      ></textarea>
      <button class="send-btn" id="sendBtn" disabled>
        <i class="fas fa-paper-plane"></i>
      </button>
    </div>
  </div>

  <!-- Toast Notification -->
  <div class="toast" id="toast">
    <i class="fas fa-info-circle" id="toastIcon"></i>
    <span id="toastMessage">Notification</span>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { ref, getDatabase, set, push, onValue, update, serverTimestamp, get, remove, onDisconnect } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";
    import { onAuthStateChanged, getAuth } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

    // Use the SAME Firebase config as homepage.html
    const firebaseConfig = {
      apiKey: "AIzaSyCy5uQGcg1cALqFSa1xAQOL6lX8Gz5nFNU",
      authDomain: "motion-flow-47450.firebasestorage.app",
      databaseURL: "https://motion-flow-47450-default-rtdb.firebaseio.com",
      projectId: "motion-flow-47450",
      storageBucket: "motion-flow-47450.firebasestorage.app",
      messagingSenderId: "686875529848",
      appId: "1:686875529848:web:48edf5164aaaf938cdd38d",
      measurementId: "G-K46N8C1HFQ"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase();

    console.log('ðŸ’¬ WhatsApp-Style Chat initialized');

    // DOM Elements
    const backBtn = document.getElementById("backBtn");
    const userInfo = document.getElementById("userInfo");
    const messagesArea = document.getElementById("messagesArea");
    const loadingContainer = document.getElementById("loadingContainer");
    const loadingText = document.getElementById("loadingText");
    const noMessages = document.getElementById("noMessages");
    const inputArea = document.getElementById("inputArea");
    const messageInput = document.getElementById("messageInput");
    const sendBtn = document.getElementById("sendBtn");
    const typingIndicator = document.getElementById("typingIndicator");
    const toast = document.getElementById("toast");
    const toastMessage = document.getElementById("toastMessage");
    const toastIcon = document.getElementById("toastIcon");
    const emojiBtn = document.getElementById("emojiBtn");
    const attachBtn = document.getElementById("attachBtn");
    const moreBtn = document.getElementById("moreBtn");
    const requestBanner = document.getElementById("requestBanner");
    const acceptRequestBtn = document.getElementById("acceptRequestBtn");
    const declineRequestBtn = document.getElementById("declineRequestBtn");
    const videoCallBtn = document.getElementById("videoCallBtn");
    const voiceCallBtn = document.getElementById("voiceCallBtn");

    // User state
    let currentUserId = null;
    let currentUserName = null;
    let currentUserAvatar = null;
    let otherUserId = null;
    let otherUserData = null;
    let messages = [];
    let isTyping = false;
    let typingTimeout = null;
    let isRequest = false;

    // Toast notification function
    function showToast(message, type = 'info') {
      toastMessage.textContent = message;
      toastIcon.className = type === 'success' ? 'fas fa-check-circle' : 
                           type === 'error' ? 'fas fa-exclamation-circle' : 
                           type === 'warning' ? 'fas fa-exclamation-triangle' :
                           'fas fa-info-circle';
      
      toast.classList.add('show');
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    // FIXED: Get user ID from URL OR sessionStorage
    function getOtherUserId() {
      // First try to get from URL
      const urlParams = new URLSearchParams(window.location.search);
      const userIdFromUrl = urlParams.get('userId');
      
      console.log('ðŸ”— URL userId:', userIdFromUrl);
      
      if (userIdFromUrl) {
        // Also store it in sessionStorage for consistency
        sessionStorage.setItem('chatWithUserId', userIdFromUrl);
        return userIdFromUrl;
      }
      
      // If no URL parameter, try sessionStorage
      console.log('ðŸ” No userId in URL, checking sessionStorage...');
      const storedUserId = sessionStorage.getItem('chatWithUserId');
      console.log('ðŸ’¾ sessionStorage userId:', storedUserId);
      
      if (storedUserId) {
        // Update URL with userId for better UX
        const newUrl = `${window.location.pathname}?userId=${storedUserId}`;
        window.history.replaceState({}, '', newUrl);
        return storedUserId;
      }
      
      console.log('âŒ No user ID found anywhere');
      return null;
    }

    // Back button functionality
    backBtn.addEventListener('click', () => {
      // Clear chat data from sessionStorage when leaving
      sessionStorage.removeItem('chatWithUserId');
      window.location.href = "chats.html";
    });

    // Video call button
    videoCallBtn.addEventListener('click', () => {
      showToast('Video call feature coming soon!', 'info');
    });

    // Voice call button
    voiceCallBtn.addEventListener('click', () => {
      showToast('Voice call feature coming soon!', 'info');
    });

    // More button functionality
    moreBtn.addEventListener('click', () => {
      showToast('More options coming soon!', 'info');
    });

    // Accept request
    acceptRequestBtn.addEventListener('click', async () => {
      try {
        // Mark conversation as accepted
        const conversationRef = ref(db, `conversations/${currentUserId}/${otherUserId}`);
        await update(conversationRef, {
          status: 'accepted',
          acceptedAt: Date.now()
        });
        
        // Hide request banner and show input
        requestBanner.style.display = 'none';
        inputArea.style.display = 'block';
        
        showToast('Message request accepted', 'success');
        
      } catch (error) {
        console.error('Error accepting request:', error);
        showToast('Failed to accept request', 'error');
      }
    });

    // Decline request
    declineRequestBtn.addEventListener('click', async () => {
      try {
        // Delete the conversation
        const conversationRef = ref(db, `conversations/${currentUserId}/${otherUserId}`);
        await remove(conversationRef);
        
        // Also delete from other user's side
        const otherConversationRef = ref(db, `conversations/${otherUserId}/${currentUserId}`);
        await remove(otherConversationRef);
        
        showToast('Message request declined', 'success');
        setTimeout(() => {
          window.location.href = "chats.html";
        }, 1500);
        
      } catch (error) {
        console.error('Error declining request:', error);
        showToast('Failed to decline request', 'error');
      }
    });

    // Auto-resize textarea
    messageInput.addEventListener('input', function() {
      this.style.height = 'auto';
      const newHeight = Math.min(this.scrollHeight, 100);
      this.style.height = newHeight + 'px';
      
      // Enable/disable send button
      sendBtn.disabled = this.value.trim().length === 0;
      
      // Update typing status
      updateTypingStatus(this.value.length > 0);
    });

    // Send message on Enter (without Shift)
    messageInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    // Send button click
    sendBtn.addEventListener('click', sendMessage);

    // Emoji button placeholder
    emojiBtn.addEventListener('click', () => {
      showToast('Emoji picker would open here', 'info');
    });

    // Attach button placeholder
    attachBtn.addEventListener('click', () => {
      showToast('Attachment options would open here', 'info');
    });

    // Update typing status
    function updateTypingStatus(typing) {
      if (typing !== isTyping) {
        isTyping = typing;
        const typingRef = ref(db, `typing/${currentUserId}/${otherUserId}`);
        set(typingRef, typing ? true : null);
      }
      
      // Clear previous timeout
      if (typingTimeout) clearTimeout(typingTimeout);
      
      // Set timeout to remove typing status after 2 seconds of inactivity
      if (typing) {
        typingTimeout = setTimeout(() => {
          updateTypingStatus(false);
        }, 2000);
      }
    }

    // Send message function
    async function sendMessage() {
      const messageText = messageInput.value.trim();
      
      if (!messageText || !currentUserId || !otherUserId) {
        return;
      }
      
      // Disable send button and clear input
      sendBtn.disabled = true;
      const messageToSend = messageText;
      messageInput.value = '';
      messageInput.style.height = 'auto';
      updateTypingStatus(false);
      
      try {
        // Generate message ID
        const messageId = push(ref(db, `conversations/${currentUserId}/${otherUserId}/messages`)).key;
        const timestamp = Date.now();
        
        // Message data
        const messageData = {
          id: messageId,
          senderId: currentUserId,
          receiverId: otherUserId,
          text: messageToSend,
          timestamp: timestamp,
          read: false,
          status: 'sent'
        };
        
        // Save to current user's conversation
        const currentUserMsgRef = ref(db, `conversations/${currentUserId}/${otherUserId}/messages/${messageId}`);
        await set(currentUserMsgRef, messageData);
        
        // Save to other user's conversation
        const otherUserMsgRef = ref(db, `conversations/${otherUserId}/${currentUserId}/messages/${messageId}`);
        await set(otherUserMsgRef, {
          ...messageData,
          status: 'delivered'
        });
        
        // Update conversation metadata
        const currentUserConvRef = ref(db, `conversations/${currentUserId}/${otherUserId}`);
        const otherUserConvRef = ref(db, `conversations/${otherUserId}/${currentUserId}`);
        
        const conversationData = {
          lastUpdated: timestamp,
          lastMessage: messageToSend,
          lastMessageTime: timestamp,
          otherUserName: otherUserData?.username || otherUserData?.nickname || 'User',
          otherUserAvatar: otherUserData?.profilePhoto || otherUserData?.profileImage || null,
          status: 'active'
        };
        
        await update(currentUserConvRef, conversationData);
        
        // For other user, check if this is a request
        const otherConversationData = {
          ...conversationData,
          otherUserName: currentUserName || 'User',
          otherUserAvatar: currentUserAvatar || null
        };
        
        // Check if conversation exists for other user
        const otherConvSnapshot = await get(otherUserConvRef);
        if (!otherConvSnapshot.exists()) {
          // This is a first-time message (request)
          otherConversationData.status = 'request';
          otherConversationData.createdAt = timestamp;
        }
        
        await update(otherUserConvRef, otherConversationData);
        
        // Play send sound
        playSendSound();
        
        // Scroll to bottom
        setTimeout(() => {
          messagesArea.scrollTop = messagesArea.scrollHeight;
        }, 100);
        
      } catch (error) {
        console.error('Error sending message:', error);
        showToast('Failed to send message', 'error');
        // Restore message
        messageInput.value = messageToSend;
      } finally {
        sendBtn.disabled = messageInput.value.trim().length === 0;
        messageInput.focus();
      }
    }

    // Play send sound
    function playSendSound() {
      try {
        const audio = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-message-pop-alert-2354.mp3');
        audio.volume = 0.3;
        audio.play();
      } catch (e) {
        console.log('Sound not supported');
      }
    }

    // Play receive sound
    function playReceiveSound() {
      try {
        const audio = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-correct-answer-tone-2870.mp3');
        audio.volume = 0.3;
        audio.play();
      } catch (e) {
        console.log('Sound not supported');
      }
    }

    // Format time
    function formatTime(timestamp) {
      const date = new Date(timestamp);
      return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    // Format date for separator
    function formatDate(timestamp) {
      const date = new Date(timestamp);
      const today = new Date();
      const yesterday = new Date(today);
      yesterday.setDate(yesterday.getDate() - 1);
      
      if (date.toDateString() === today.toDateString()) {
        return 'Today';
      } else if (date.toDateString() === yesterday.toDateString()) {
        return 'Yesterday';
      } else {
        return date.toLocaleDateString([], { weekday: 'long', month: 'short', day: 'numeric' });
      }
    }

    // Render messages
    function renderMessages() {
      console.log('ðŸ“¨ Rendering messages:', messages.length);
      
      if (messages.length === 0) {
        console.log('ðŸ“­ No messages found, showing empty state');
        loadingContainer.style.display = 'none';
        noMessages.style.display = 'flex';
        inputArea.style.display = 'block';
        return;
      }
      
      loadingContainer.style.display = 'none';
      noMessages.style.display = 'none';
      inputArea.style.display = 'block';
      
      // Clear existing messages except typing indicator
      const existingMessages = messagesArea.querySelectorAll('.message, .date-separator');
      existingMessages.forEach(msg => msg.remove());
      
      let lastDate = null;
      
      // Add messages with date separators
      messages.forEach((msg, index) => {
        const msgDate = new Date(msg.timestamp).toDateString();
        
        // Add date separator if date changed
        if (lastDate !== msgDate) {
          const dateSeparator = document.createElement('div');
          dateSeparator.className = 'date-separator';
          dateSeparator.innerHTML = `<span>${formatDate(msg.timestamp)}</span>`;
          messagesArea.appendChild(dateSeparator);
          lastDate = msgDate;
        }
        
        const isSent = msg.senderId === currentUserId;
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${isSent ? 'sent' : 'received'} ${index === messages.length - 1 ? 'new' : ''}`;
        
        // Get status icon
        let statusIcon = 'fa-check';
        let statusTitle = 'Sent';
        if (msg.status === 'delivered') {
          statusIcon = 'fa-check-double';
          statusTitle = 'Delivered';
        } else if (msg.status === 'read') {
          statusIcon = 'fa-check-double';
          statusTitle = 'Read';
        }
        
        messageDiv.innerHTML = `
          <div class="message-bubble">
            <div class="message-text">${escapeHtml(msg.text)}</div>
            <div class="message-info">
              <span class="message-time">${formatTime(msg.timestamp)}</span>
              ${isSent ? `<span class="message-status" title="${statusTitle}"><i class="fas ${statusIcon}"></i></span>` : ''}
            </div>
          </div>
        `;
        
        messagesArea.appendChild(messageDiv);
      });
      
      // Scroll to bottom
      setTimeout(() => {
        messagesArea.scrollTop = messagesArea.scrollHeight;
      }, 100);
    }

    // Escape HTML to prevent XSS
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML.replace(/\n/g, '<br>');
    }

    // Auth state listener
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUserId = user.uid;
        console.log('âœ… User logged in:', user.uid);
        
        // Set current user as online
        await setUserOnlineStatus(currentUserId, true);
        
        // Get the otherUserId from URL or sessionStorage
        otherUserId = getOtherUserId();
        
        if (!otherUserId) {
          loadingText.textContent = "No user specified. Redirecting to chats list...";
          showToast("No user specified. Redirecting to chats list...", "error");
          setTimeout(() => {
            window.location.href = "chats.html";
          }, 2000);
          return;
        }
        
        console.log('ðŸ’¬ Chatting with user ID:', otherUserId);
        
        // Load current user data
        const userRef = ref(db, `users/${user.uid}`);
        onValue(userRef, (snapshot) => {
          if (snapshot.exists()) {
            const userData = snapshot.val();
            currentUserName = userData.username || userData.name || "User";
            currentUserAvatar = userData.profilePhoto || userData.profileImage || `https://ui-avatars.com/api/?name=${currentUserName}&background=00bcd4&color=fff`;
          }
        });
        
        // Load other user data
        await loadOtherUserData();
        
        // Check if this is a request
        await checkIfRequest();
        
        // Load messages
        loadMessages();
        
        // Listen for new messages
        listenForNewMessages();
        
        // Listen for typing status
        listenForTyping();
        
        // Listen for user online status
        listenForUserStatus();
        
      } else {
        window.location.href = "../index.html";
      }
    });

    // Set user online status
    async function setUserOnlineStatus(userId, isOnline) {
      try {
        const statusRef = ref(db, `users/${userId}/status`);
        await set(statusRef, isOnline ? 'online' : 'offline');
        
        // Set up disconnect handler to mark as offline when user leaves
        if (isOnline) {
          const disconnectRef = ref(db, `.info/connected`);
          onValue(disconnectRef, (snapshot) => {
            if (snapshot.val() === false) {
              // User disconnected
              set(statusRef, 'offline');
            }
          });
          
          // Also mark offline when page is closed
          onDisconnect(statusRef).set('offline');
        }
      } catch (error) {
        console.error('Error setting online status:', error);
      }
    }

    // Check if conversation is a request
    async function checkIfRequest() {
      try {
        const conversationRef = ref(db, `conversations/${currentUserId}/${otherUserId}`);
        const snapshot = await get(conversationRef);
        
        if (snapshot.exists()) {
          const conversationData = snapshot.val();
          isRequest = conversationData.status === 'request';
          
          if (isRequest) {
            console.log('ðŸ“¥ This is a message request');
            // Show request banner
            requestBanner.style.display = 'block';
            inputArea.style.display = 'none';
          } else {
            console.log('âœ… This is an accepted conversation');
            // Hide request banner, show input
            requestBanner.style.display = 'none';
            inputArea.style.display = 'block';
          }
        } else {
          console.log('ðŸ†• No conversation exists yet, this will be a new chat');
          requestBanner.style.display = 'none';
          inputArea.style.display = 'block';
        }
      } catch (error) {
        console.error('Error checking request status:', error);
        // Don't show error toast here - just log it
        requestBanner.style.display = 'none';
        inputArea.style.display = 'block';
      }
    }

    // Load other user data
    async function loadOtherUserData() {
      try {
        loadingText.textContent = "Loading user info...";
        
        // Load user data from Firebase
        const otherUserRef = ref(db, `users/${otherUserId}`);
        const snapshot = await get(otherUserRef);
        
        if (snapshot.exists()) {
          otherUserData = snapshot.val();
          otherUserData.id = otherUserId;
          
          console.log('ðŸ‘¤ Firebase user data loaded:', otherUserData);
          
          // Update header
          updateChatHeader();
          
          // Make the user info clickable
          makeUserInfoClickable();
          
        } else {
          console.log('âŒ User not found in database');
          loadingText.textContent = "User not found. Redirecting...";
          showToast('User not found', 'error');
          setTimeout(() => {
            window.location.href = "chats.html";
          }, 2000);
        }
      } catch (error) {
        console.error('Error loading user data:', error);
        loadingText.textContent = "Error loading user data";
      }
    }

    // Make user info clickable to go to user profile
    function makeUserInfoClickable() {
      if (!otherUserId || !otherUserData) return;
      
      // Add click event to user info
      userInfo.addEventListener('click', () => {
        console.log('ðŸ‘¤ Clicked on user info, going to profile:', otherUserId);
        window.location.href = `../Users/user-profile.html?userId=${otherUserId}`;
      });
      
      // Add cursor pointer style
      userInfo.style.cursor = 'pointer';
    }

    // Update chat header with Firebase data
    function updateChatHeader() {
      if (!otherUserData) return;
      
      const name = otherUserData.username || otherUserData.nickname || otherUserData.name || 'User';
      const profilePhoto = otherUserData.profilePhoto || otherUserData.profileImage || `https://ui-avatars.com/api/?name=${name}&background=00bcd4&color=fff`;
      
      userInfo.innerHTML = `
        <img src="${profilePhoto}" 
             alt="${name}" 
             class="user-avatar"
             onerror="this.src='https://ui-avatars.com/api/?name=${name}&background=00bcd4&color=fff'">
        <div class="user-details">
          <h3>${name}</h3>
          <p id="userStatus">
            <span class="offline">Loading status...</span>
          </p>
        </div>
      `;
    }

    // Listen for user status
    function listenForUserStatus() {
      if (!otherUserId) return;
      
      const statusRef = ref(db, `users/${otherUserId}/status`);
      onValue(statusRef, (snapshot) => {
        const status = snapshot.val();
        console.log('ðŸ“± User status updated:', otherUserId, '=', status);
        
        if (otherUserData) {
          otherUserData.status = status || 'offline';
          updateStatusDisplay(status);
        }
      });
    }

    // Update status display
    function updateStatusDisplay(status) {
      const userStatusElement = document.getElementById('userStatus');
      if (!userStatusElement) return;
      
      if (status === 'online') {
        userStatusElement.innerHTML = '<span class="dot"></span> Online';
        userStatusElement.style.color = 'var(--color-success)';
      } else {
        userStatusElement.innerHTML = '<span class="offline">Offline</span>';
        userStatusElement.style.color = 'var(--color-text-muted)';
      }
    }

    // Load messages
    function loadMessages() {
      loadingText.textContent = "Loading messages...";
      
      const messagesRef = ref(db, `conversations/${currentUserId}/${otherUserId}/messages`);
      
      console.log('ðŸ“¥ Loading messages from path:', `conversations/${currentUserId}/${otherUserId}/messages`);
      
      onValue(messagesRef, (snapshot) => {
        console.log('ðŸ“Š Messages snapshot:', snapshot.exists() ? 'EXISTS' : 'EMPTY');
        
        if (snapshot.exists()) {
          const messagesData = snapshot.val();
          console.log('ðŸ“© Raw messages data:', messagesData);
          
          messages = Object.values(messagesData)
            .map(msg => ({ ...msg }))
            .sort((a, b) => a.timestamp - b.timestamp);
          
          console.log('âœ… Messages loaded successfully:', messages.length);
          renderMessages();
          
          // Mark messages as read
          markMessagesAsRead();
        } else {
          console.log('ðŸ“­ No messages found (this is normal for new chats)');
          messages = [];
          renderMessages();
        }
      }, (error) => {
        console.error('âŒ Error loading messages:', error);
        // DON'T show toast for this error - it's normal for new chats
        // Just hide loading and show empty state
        loadingContainer.style.display = 'none';
        noMessages.style.display = 'flex';
        inputArea.style.display = 'block';
      });
    }

    // Listen for new messages
    function listenForNewMessages() {
      const messagesRef = ref(db, `conversations/${currentUserId}/${otherUserId}/messages`);
      
      onValue(messagesRef, (snapshot) => {
        if (snapshot.exists()) {
          const messagesData = snapshot.val();
          const newMessages = Object.values(messagesData)
            .map(msg => ({ ...msg }))
            .sort((a, b) => a.timestamp - b.timestamp);
          
          // Check if there are new messages
          if (newMessages.length > messages.length) {
            const newMessage = newMessages[newMessages.length - 1];
            
            // Play sound if message is from other user
            if (newMessage.senderId !== currentUserId) {
              playReceiveSound();
              showToast(`New message from ${otherUserData?.username || otherUserData?.nickname || 'User'}`, 'info');
              
              // Update message status to read
              if (newMessage.status === 'delivered') {
                updateMessageStatus(newMessage.id, 'read');
              }
            }
          }
          
          messages = newMessages;
          renderMessages();
          
          // Mark messages as read
          markMessagesAsRead();
        }
      });
    }

    // Update message status
    async function updateMessageStatus(messageId, status) {
      try {
        const messageRef = ref(db, `conversations/${currentUserId}/${otherUserId}/messages/${messageId}`);
        await update(messageRef, { status: status });
      } catch (error) {
        console.error('Error updating message status:', error);
      }
    }

    // Mark messages as read
    function markMessagesAsRead() {
      if (!currentUserId || !otherUserId) return;
      
      // Mark all unread messages from other user as read
      messages.forEach(async (msg) => {
        if (msg.senderId !== currentUserId && msg.status !== 'read') {
          await updateMessageStatus(msg.id, 'read');
          
          // Also update in other user's conversation
          const otherUserMsgRef = ref(db, `conversations/${otherUserId}/${currentUserId}/messages/${msg.id}`);
          await update(otherUserMsgRef, { status: 'read' });
        }
      });
    }

    // Listen for typing status
    function listenForTyping() {
      const typingRef = ref(db, `typing/${otherUserId}/${currentUserId}`);
      
      onValue(typingRef, (snapshot) => {
        if (snapshot.exists()) {
          typingIndicator.style.display = 'flex';
        } else {
          typingIndicator.style.display = 'none';
        }
        
        // Scroll to bottom when typing appears/disappears
        setTimeout(() => {
          messagesArea.scrollTop = messagesArea.scrollHeight;
        }, 100);
      });
    }

    // Initialize on load
    document.addEventListener('DOMContentLoaded', () => {
      console.log('ðŸ’¬ WhatsApp-style chat page loaded');
      
      // Focus on input when page loads
      setTimeout(() => {
        messageInput.focus();
      }, 500);
      
      // Auto-focus on input when clicking anywhere in messages area
      messagesArea.addEventListener('click', () => {
        messageInput.focus();
      });
    });

    // Clean up when page is closed
    window.addEventListener('beforeunload', () => {
      if (currentUserId) {
        setUserOnlineStatus(currentUserId, false);
      }
    });

  </script>
</body>
</html>